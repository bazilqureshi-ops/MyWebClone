@using Emse.QMagic.DAL;
@using Emse.QMagic.WebTerminal.Helpers;
@{
    Layout = null;
    string LanguageCode = "EN";
    if (Session["MagicLanguage"] != null)
    {
        LanguageCode = Session["MagicLanguage"].ToString();
    }

    qmTicket Ticket = ViewBag.Ticket;
    qmService Service = ViewBag.Service;
    qmSegment Segment = ViewBag.Segment;
    List<qmService> Services = ViewBag.Services;
    List<qmSegment> Segments = ViewBag.Segments;
    qmCustomer Customer = ViewBag.Customer;

    TimeSpan WaitingTime = TimeSpan.FromTicks(0);
    if (Ticket != null)
    {
        long longPrint = Ticket.PrintTime.Ticks;
        long longNow = DateTime.Now.Ticks;
        long DifferenceTime = longNow - longPrint;
        WaitingTime = TimeSpan.FromTicks(DifferenceTime);
    }

    bool? isTransferred = ViewBag.isTransferred;
    string TransferText = "";

    if (isTransferred != null && isTransferred == true)
    {
        List<qmTransferService> Transfers = ViewBag.TransferredService;
        foreach (qmTransferService transfer in Transfers)
        {
            qmSegment tsegment = Segments.Where(x => x.SegmentID == transfer.TransferSegmentID).FirstOrDefault();
            TransferText += " > " + Services.Where(x => x.ServiceID == tsegment.ServiceID).FirstOrDefault().ServiceName;
        }
    }
}

@if (Ticket != null && Ticket.TicketPrefix != "PAUSE")
{
    <div class="infobox-container">
        <div class="infobox-header">
            <div class="ticket-number">
                @Ticket.TicketPrefix@Ticket.TicketNumber
            </div>
            <div class="ticket-service">
                @Service.ServiceName @Html.Raw(TransferText)
            </div>
        </div>
        <div class="infobox-body">
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">@Localization.Translate(LanguageCode, "Segment")</span>
                    <span class="info-value">@Segment.SegmentName</span>
                </div>
                <div class="info-item">
                    <span class="info-label">@Localization.Translate(LanguageCode, "PrintTime")</span>
                    <span class="info-value">@Ticket.PrintTime.ToShortTimeString()</span>
                </div>
                <div class="info-item">
                    <span class="info-label">@Localization.Translate(LanguageCode, "WaitingTime")</span>
                    <span class="info-value">@WaitingTime.Hours:@WaitingTime.Minutes:@WaitingTime.Seconds</span>
                </div>
                <div class="info-item">
                    <span class="info-label">@Localization.Translate(LanguageCode, "TransactionTime")</span>
                    <span class="info-value elapsedtime" sec="0">00:00:00</span>
                </div>
            </div>
            <div class="info-actions">
                <button class="btn-secondary" onclick="MoreInformation(@Ticket.TicketID);">
                    <i class="fa fa-user"></i> @Localization.Translate(LanguageCode, "MoreInformation")
                </button>
                <button class="btn-secondary" onclick="$('#ChangeCustomerModal').show();">
                    <i class="fa fa-user-circle"></i> Change Info
                </button>
            </div>
        </div>
        <div class="infobox-footer">
            <input type="text" class="form-control" placeholder="Ticket Note..." id="txtTicketNote" value="@Ticket.TicketNote" />
            <button class="btn-primary" onclick="SaveTicketNote();"><i class="fa fa-check"></i></button>
        </div>
    </div>

    if (Customer != null)
    {
        <div class="customer-details">
            <div class="info-item">
                <span class="info-label">Patient Name</span>
                <span class="info-value">@Customer.Name @Customer.Surname</span>
            </div>
            <div class="info-item">
                <span class="info-label">QID</span>
                <span class="info-value">@Customer.UniqueID</span>
            </div>
            <div class="info-item">
                <span class="info-label">HC Number</span>
                <span class="info-value">@Customer.HCID</span>
            </div>
             <div class="info-item">
                <span class="info-label">Phone</span>
                <span class="info-value">@Customer.Phone</span>
            </div>
            <div class="info-item">
                <span class="info-label">Nationality</span>
                <span class="info-value">@Customer.Country</span>
            </div>
            <div class="info-item">
                <span class="info-label">Birth Date</span>
                <span class="info-value">@Customer.BirthDate.Value.ToShortDateString()</span>
            </div>
        </div>
    }

    <input type="hidden" id="InfoTicketID" name="InfoTicketID" value="@Ticket.TicketID" />
    <input type="hidden" id="InfoCustomerID" name="InfoCustomerID" value="@Ticket.CustomerID" />
}
else
{
    <div class="infobox-container placeholder">
        <div class="infobox-header">
            <div class="ticket-number">N/A</div>
        </div>
        <div class="infobox-body">
            <p>@Localization.Translate(LanguageCode, "NoTicketIsCurrentlyBeingServed")</p>
            <p>@Localization.Translate(LanguageCode, "ClickNextCallToProceed")</p>
        </div>
    </div>
}
