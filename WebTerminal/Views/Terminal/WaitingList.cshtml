@using Emse.QMagic.DAL;
@using Emse.QMagic.WebTerminal.Helpers;
@{
    Layout = null;
    string LanguageCode = "EN";
    if (Session["MagicLanguage"] != null)
    {
        LanguageCode = Session["MagicLanguage"].ToString();
    }
    List<qmTicket> WaitingList = ViewBag.WaitingList;
    List<qmService> ServiceList = ViewBag.ServiceList;
    List<qmSegment> SegmentList = ViewBag.SegmentList;
}

<script>
    // This script block is to update the badge count in the main UI if it exists
    var waitingCount = @(WaitingList.Count);
    if ($("#TotalWaitingBadge").length) {
        $("#TotalWaitingBadge").html(waitingCount);
    }
</script>

@if (WaitingList.Count < 1)
{
    <div class="empty-state">
        <i class="fa fa-laugh-beam"></i>
        <h3>@Localization.Translate(LanguageCode, "ThereIsNoWaitingInYourQueue")</h3>
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>@Localization.Translate(LanguageCode, "TicketID")</th>
                    <th>@Localization.Translate(LanguageCode, "Service")</th>
                    <th>@Localization.Translate(LanguageCode, "PrintTime")</th>
                    <th>@Localization.Translate(LanguageCode, "WaitingTime")</th>
                    <th>@Localization.Translate(LanguageCode, "Actions")</th>
                </tr>
            </thead>
            <tbody>
                @foreach (qmTicket ticket in WaitingList.OrderBy(t => t.PrintTime))
                {
                    qmSegment segment = SegmentList.FirstOrDefault(s => s.SegmentID == ticket.SegmentID);
                    qmService service = ServiceList.FirstOrDefault(s => s.ServiceID == segment?.ServiceID);

                    long nowTicks = DateTime.Now.Ticks;
                    long printTicks = ticket.PrintTime.Ticks;
                    TimeSpan waitingTime = TimeSpan.FromTicks(nowTicks - printTicks);

                    <tr>
                        <td><span class="ticket-id">@ticket.TicketPrefix@ticket.TicketNumber</span></td>
                        <td>@(service?.ServiceName)</td>
                        <td>@ticket.PrintTime.ToShortTimeString()</td>
                        <td>@waitingTime.ToString(@"hh\:mm\:ss")</td>
                        <td>
                            <button class="btn-icon" onclick="CallFromPark(@ticket.TicketID)">
                                <i class="fa fa-hand-point-up"></i>
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}